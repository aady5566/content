name: Auto Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - '1115-rotary-club/1115-slide.html'
      - '1115-rotary-club/slides-content.json'
      - '1115-rotary-club/scripts/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾† commit ç”Ÿæˆçš„æª”æ¡ˆ

    # è·³éè‡ªå‹•å»ºç½®çš„ commitï¼ˆé¿å…ç„¡é™å¾ªç’°ï¼‰
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # éœ€è¦å®Œæ•´æ­·å²ä¾† commit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (if needed)
        working-directory: ./1115-rotary-club
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰ package.jsonï¼Œå¦‚æœæ²’æœ‰å°±å»ºç«‹
          if [ ! -f package.json ]; then
            echo "{}" > package.json
          fi

      - name: Build slides (extract, inject, remove content)
        working-directory: ./1115-rotary-club
        run: |
          echo "ğŸš€ é–‹å§‹è‡ªå‹•å»ºç½®ï¼ˆç°¡åŒ–ç‰ˆï¼‰..."
          
          # åŸ·è¡Œç°¡åŒ–ç‰ˆå»ºç½®æµç¨‹ï¼ˆä¸åŠ å¯†ï¼‰
          node scripts/extract-content.js
          node scripts/inject-loader-simple.js
          node scripts/remove-content-from-html.js
          node scripts/prepare-production.js
          
          echo "âœ… å»ºç½®å®Œæˆ"

      - name: Check for changes and commit
        run: |
          cd 1115-rotary-club
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet slides-content.json 1115-slide.html; then
            echo "â„¹ï¸  æ²’æœ‰è®Šæ›´ï¼Œè·³é commit"
          else
            echo "ğŸ“ åµæ¸¬åˆ°è®Šæ›´ï¼Œæº–å‚™ commit"
            git add slides-content.json 1115-slide.html
            git commit -m "ğŸ¤– Auto build: æ›´æ–° JSON å…§å®¹å’Œè¼‰å…¥å™¨ [skip ci]" || exit 0
            git push
          fi

      - name: Summary
        run: |
          echo "âœ… è‡ªå‹•å»ºç½®å®Œæˆï¼"
          echo "ğŸ“ JSON å…§å®¹å·²æ›´æ–°"
          echo "ğŸš€ GitHub Pages æœƒè‡ªå‹•éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬"

